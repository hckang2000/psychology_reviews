{% extends 'base.html' %}
{% load static %}

{% block title %}ë¦¬ë·° ê´€ë¦¬{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'centers/css/variables.css' %}">
<link rel="stylesheet" href="{% static 'centers/css/common.css' %}">
<link rel="stylesheet" href="{% static 'centers/css/review-management.css' %}">
{% endblock %}

{% block extra_js %}
<script src="{% static 'centers/js/review-comments.js' %}"></script>
{% endblock %}

{% block content %}
<div class="review-management">
    <div class="management-header">
        <a href="{% url 'centers:management_dashboard' %}" class="back-button">
            â† ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°
        </a>
        <h1>ğŸ’¬ ë¦¬ë·° ê´€ë¦¬</h1>
        <p>
            {% if profile.is_admin %}
                ëª¨ë“  ì„¼í„°ì˜ ë¦¬ë·°ë¥¼ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            {% else %}
                ë‹´ë‹¹ ì„¼í„°ì˜ ë¦¬ë·°ë¥¼ ê´€ë¦¬í•˜ê³  ë‹µë³€ì„ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            {% endif %}
        </p>
    </div>
    
    <!-- ê²€ìƒ‰ ê¸°ëŠ¥ -->
    <div class="search-section">
        <form method="get" class="search-form">
            <div class="search-input-group">
                <input type="text" 
                       name="search" 
                       value="{{ search_query }}" 
                       placeholder="ë¦¬ë·° ì œëª©, ë‚´ìš©, ì‘ì„±ìë¡œ ê²€ìƒ‰..."
                       class="search-input">
                <button type="submit" class="search-button">
                    ğŸ” ê²€ìƒ‰
                </button>
            </div>
        </form>
    </div>
    
    <!-- ë¦¬ë·° ëª©ë¡ -->
    <div class="reviews-section">
        {% if reviews %}
            <div class="reviews-stats">
                <p>ì´ {{ page_obj.paginator.count }}ê°œì˜ ë¦¬ë·°ê°€ ìˆìŠµë‹ˆë‹¤.</p>
            </div>
            
            <div class="reviews-list">
                {% for review in reviews %}
                    <div class="review-card" data-review-id="{{ review.id }}">
                        <div class="review-header">
                            <div class="review-info">
                                <h3 class="review-title">{{ review.title }}</h3>
                                <div class="review-meta">
                                    <span class="review-center">ğŸ“ {{ review.center.name }}</span>
                                    <span class="review-author">ğŸ‘¤ {{ review.user.username }}</span>
                                    <span class="review-rating">â­ {{ review.rating }}/5</span>
                                    <span class="review-date">ğŸ“… {{ review.created_at|date:"Y-m-d H:i" }}</span>
                                </div>
                            </div>
                            <div class="review-actions">
                                <button class="toggle-comments-btn" onclick="toggleComments({{ review.id }})">
                                    ğŸ’¬ ëŒ“ê¸€ ({{ review.comments.count }})
                                </button>
                            </div>
                        </div>
                        
                        <div class="review-content">
                            <p>{{ review.content|linebreaks }}</p>
                        </div>
                        
                        <!-- ëŒ“ê¸€ ì„¹ì…˜ -->
                        <div class="comments-section" id="comments-{{ review.id }}" style="display: none;">
                            <div class="comments-header">
                                <h4>ğŸ’¬ ì„¼í„° ë‹µë³€</h4>
                            </div>
                            
                            <!-- ê¸°ì¡´ ëŒ“ê¸€ ëª©ë¡ -->
                            <div class="comments-list" id="comments-list-{{ review.id }}">
                                {% for comment in review.comments.all %}
                                    <div class="comment-item" data-comment-id="{{ comment.id }}">
                                        <div class="comment-header">
                                            <span class="comment-author">ğŸ¢ {{ comment.author.username }}</span>
                                            <span class="comment-date">{{ comment.created_at|date:"Y-m-d H:i" }}</span>
                                            {% if comment.author == request.user %}
                                                <div class="comment-actions">
                                                    <button class="edit-comment-btn" onclick="editComment({{ comment.id }})">
                                                        âœï¸ ìˆ˜ì •
                                                    </button>
                                                    <button class="delete-comment-btn" onclick="deleteComment({{ comment.id }})">
                                                        ğŸ—‘ï¸ ì‚­ì œ
                                                    </button>
                                                </div>
                                            {% endif %}
                                        </div>
                                        <div class="comment-content" id="comment-content-{{ comment.id }}">
                                            {{ comment.content|linebreaks }}
                                        </div>
                                        <div class="comment-edit-form" id="comment-edit-form-{{ comment.id }}" style="display: none;">
                                            <textarea class="comment-edit-textarea" id="comment-edit-textarea-{{ comment.id }}">{{ comment.content }}</textarea>
                                            <div class="comment-edit-actions">
                                                <button class="save-comment-btn" onclick="saveComment({{ comment.id }})">
                                                    ğŸ’¾ ì €ì¥
                                                </button>
                                                <button class="cancel-edit-btn" onclick="cancelEdit({{ comment.id }})">
                                                    âŒ ì·¨ì†Œ
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                            
                            <!-- ìƒˆ ëŒ“ê¸€ ì‘ì„± í¼ -->
                            <div class="add-comment-form">
                                <textarea class="comment-textarea" 
                                         id="comment-textarea-{{ review.id }}" 
                                         placeholder="ì´ ë¦¬ë·°ì— ëŒ€í•œ ì„¼í„°ì˜ ë‹µë³€ì„ ì‘ì„±í•´ì£¼ì„¸ìš”..."></textarea>
                                <div class="comment-form-actions">
                                    <button class="add-comment-btn" onclick="addComment({{ review.id }})">
                                        ğŸ’¬ ë‹µë³€ ì‘ì„±
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
            
            <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
            {% if page_obj.has_other_pages %}
                <div class="pagination-container">
                    <div class="pagination">
                        {% if page_obj.has_previous %}
                            <a href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}" class="pagination-button">
                                â®ï¸ ì²˜ìŒ
                            </a>
                            <a href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}" class="pagination-button">
                                â—€ï¸ ì´ì „
                            </a>
                        {% endif %}
                        
                        {% for num in page_obj.paginator.page_range %}
                            {% if page_obj.number == num %}
                                <span class="pagination-button current">{{ num }}</span>
                            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                <a href="?page={{ num }}{% if search_query %}&search={{ search_query }}{% endif %}" class="pagination-button">{{ num }}</a>
                            {% endif %}
                        {% endfor %}
                        
                        {% if page_obj.has_next %}
                            <a href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}" class="pagination-button">
                                ë‹¤ìŒ â–¶ï¸
                            </a>
                            <a href="?page={{ page_obj.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}" class="pagination-button">
                                ë§ˆì§€ë§‰ â­ï¸
                            </a>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        {% else %}
            <div class="no-reviews">
                <h3>ğŸ“ ê´€ë¦¬í•  ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
                {% if search_query %}
                    <p>"{{ search_query }}"ì— ëŒ€í•œ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                    <a href="{% url 'centers:review_management' %}" class="clear-search-btn">
                        ğŸ”„ ì „ì²´ ë¦¬ë·° ë³´ê¸°
                    </a>
                {% else %}
                    <p>ì•„ì§ ì‘ì„±ëœ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                {% endif %}
            </div>
        {% endif %}
    </div>
</div>
{% endblock %} 