{% extends 'base.html' %}
{% load static %}
{% load cloudinary_tags %}

{% block title %}{{ center.name }} ê´€ë¦¬{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'centers/css/variables.css' %}">
<link rel="stylesheet" href="{% static 'centers/css/common.css' %}">
<link rel="stylesheet" href="{% static 'centers/css/management.css' %}">
<style>
    /* ì‚­ì œ ì˜ˆì • í•­ëª© ìŠ¤íƒ€ì¼ */
    .formset-item.to-delete {
        opacity: 0.5;
        background-color: #fee;
        border: 2px solid #f87171;
        position: relative;
    }
    
    .formset-item.to-delete::before {
        content: "ì‚­ì œ ì˜ˆì •";
        position: absolute;
        top: 10px;
        right: 10px;
        background-color: #ef4444;
        color: white;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
    }
    
    .delete-checkbox {
        margin-bottom: 10px;
        padding: 10px;
        background-color: #fef2f2;
        border: 1px solid #fecaca;
        border-radius: 4px;
    }
    
    .delete-checkbox label {
        color: #dc2626;
        font-weight: bold;
        cursor: pointer;
    }
    
    .delete-checkbox input[type="checkbox"] {
        margin-right: 8px;
        transform: scale(1.2);
    }
    
    /* ë™ì  í¼ ê´€ë¦¬ ìŠ¤íƒ€ì¼ */
    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .formset-controls {
        display: flex;
        gap: 10px;
    }
    
    .formset-item {
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        background-color: #f9fafb;
        position: relative;
    }
    
    .formset-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .formset-item-header h4 {
        margin: 0;
        color: #374151;
        font-size: 18px;
        font-weight: 600;
    }
    
    .formset-item-controls {
        display: flex;
        gap: 8px;
    }
    
    .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }
    
    .btn-success {
        background-color: #10b981;
        color: white;
    }
    
    .btn-success:hover {
        background-color: #059669;
        transform: translateY(-1px);
    }
    
    .btn-danger {
        background-color: #ef4444;
        color: white;
    }
    
    .btn-danger:hover {
        background-color: #dc2626;
        transform: translateY(-1px);
    }
    
    .btn:active {
        transform: translateY(0);
    }
    
    /* í¼ì…‹ ì•„ì´í…œ ì• ë‹ˆë©”ì´ì…˜ */
    .formset-item.fade-in {
        animation: fadeInUp 0.3s ease-out;
    }
    
    .formset-item.fade-out {
        animation: fadeOutDown 0.3s ease-out;
    }
    
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    @keyframes fadeOutDown {
        from {
            opacity: 1;
            transform: translateY(0);
        }
        to {
            opacity: 0;
            transform: translateY(20px);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="center-management">
    <div class="management-header">
        <a href="{% url 'centers:management_dashboard' %}" class="back-button">
            â† ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°
        </a>
        <h1>ğŸ“ {{ center.name }} ê´€ë¦¬</h1>
        <p>ì„¼í„° ì •ë³´, ìƒë‹´ì‚¬, ì´ë¯¸ì§€ë¥¼ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
    </div>
    
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        
        <!-- ì„¼í„° ê¸°ë³¸ ì •ë³´ -->
        <div class="form-section">
            <h2 class="section-title">ğŸ¢ ì„¼í„° ê¸°ë³¸ ì •ë³´</h2>
            
            <div class="form-row">
                <div class="form-group">
                    {{ form.name.label_tag }}
                    {{ form.name }}
                    {% if form.name.errors %}
                        <div class="error-message">{{ form.name.errors.0 }}</div>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    {{ form.type.label_tag }}
                    {{ form.type }}
                    {% if form.type.errors %}
                        <div class="error-message">{{ form.type.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>
            
            <div class="form-group">
                {{ form.address.label_tag }}
                {{ form.address }}
                {% if form.address.errors %}
                    <div class="error-message">{{ form.address.errors.0 }}</div>
                {% endif %}
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    {{ form.phone.label_tag }}
                    {{ form.phone }}
                    {% if form.phone.errors %}
                        <div class="error-message">{{ form.phone.errors.0 }}</div>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    {{ form.url.label_tag }}
                    {{ form.url }}
                    {% if form.url.errors %}
                        <div class="error-message">{{ form.url.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>
            
            <div class="form-group">
                {{ form.operating_hours.label_tag }}
                {{ form.operating_hours }}
                {% if form.operating_hours.errors %}
                    <div class="error-message">{{ form.operating_hours.errors.0 }}</div>
                {% endif %}
            </div>
            
            <div class="form-group">
                {{ form.description.label_tag }}
                {{ form.description }}
                {% if form.description.errors %}
                    <div class="error-message">{{ form.description.errors.0 }}</div>
                {% endif %}
            </div>
        </div>
        
        <!-- ìƒë‹´ì‚¬ ì •ë³´ -->
        <div class="form-section">
            <div class="section-header">
                <h2 class="section-title">ğŸ‘¨â€âš•ï¸ ìƒë‹´ì‚¬ ì •ë³´</h2>
                <div class="formset-controls">
                    <button type="button" id="add-therapist" class="btn btn-success">
                        â• ìƒë‹´ì‚¬ ì¶”ê°€
                    </button>
                </div>
            </div>
            
            {{ therapist_formset.management_form }}
            <div id="therapist-forms-container">
                {% for form in therapist_formset %}
                    <div class="formset-item" data-form-index="{{ forloop.counter0 }}">
                        <div class="formset-item-header">
                            <h4>ìƒë‹´ì‚¬ #{{ forloop.counter }}</h4>
                            <div class="formset-item-controls">
                                {% if not forloop.first %}
                                    <button type="button" class="btn btn-danger remove-therapist">
                                        â– ì‚­ì œ
                                    </button>
                                {% endif %}
                            </div>
                        </div>
                        
                        {% if form.DELETE %}
                            <div class="delete-checkbox">
                                {{ form.DELETE }}
                                {{ form.DELETE.label_tag }}
                            </div>
                        {% endif %}
                        
                        {{ form.id }}
                        
                        <div class="form-row">
                            <div class="form-group">
                                {{ form.name.label_tag }}
                                {{ form.name }}
                                {% if form.name.errors %}
                                    <div class="error-message">{{ form.name.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="form-group">
                                {{ form.experience.label_tag }}
                                {{ form.experience }}
                                {% if form.experience.errors %}
                                    <div class="error-message">{{ form.experience.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="form-group">
                            {{ form.specialty.label_tag }}
                            {{ form.specialty }}
                            {% if form.specialty.errors %}
                                <div class="error-message">{{ form.specialty.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="form-group">
                            {{ form.description.label_tag }}
                            {{ form.description }}
                            {% if form.description.errors %}
                                <div class="error-message">{{ form.description.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="form-group">
                            {{ form.photo.label_tag }}
                            {{ form.photo }}
                            {% if form.photo.errors %}
                                <div class="error-message">{{ form.photo.errors.0 }}</div>
                            {% endif %}
                            {% if form.instance.id %}
                                {% with therapist_photo_url=form.instance|cloudinary_url %}
                                    {% if therapist_photo_url %}
                                        <img src="{{ therapist_photo_url|optimize_cloudinary:'w_200,h_200,c_fill,q_auto' }}" 
                                             alt="ìƒë‹´ì‚¬ ì‚¬ì§„" 
                                             class="therapist-photo-preview">
                                    {% endif %}
                                {% endwith %}
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- ì„¼í„° ì´ë¯¸ì§€ -->
        <div class="form-section">
            <div class="section-header">
                <h2 class="section-title">ğŸ“¸ ì„¼í„° ì´ë¯¸ì§€</h2>
                <div class="formset-controls">
                    <button type="button" id="add-image" class="btn btn-success">
                        â• ì´ë¯¸ì§€ ì¶”ê°€
                    </button>
                </div>
            </div>
            
            {{ image_formset.management_form }}
            <div id="image-forms-container">
                {% for form in image_formset %}
                    <div class="formset-item" data-form-index="{{ forloop.counter0 }}">
                        <div class="formset-item-header">
                            <h4>ì´ë¯¸ì§€ #{{ forloop.counter }}</h4>
                            <div class="formset-item-controls">
                                {% if not forloop.first %}
                                    <button type="button" class="btn btn-danger remove-image">
                                        â– ì‚­ì œ
                                    </button>
                                {% endif %}
                            </div>
                        </div>
                        
                        {% if form.DELETE %}
                            <div class="delete-checkbox">
                                {{ form.DELETE }}
                                {{ form.DELETE.label_tag }}
                            </div>
                        {% endif %}
                        
                        {{ form.id }}
                        
                        <div class="form-group">
                            {{ form.image.label_tag }}
                            {{ form.image }}
                            {% if form.image.errors %}
                                <div class="error-message">{{ form.image.errors.0 }}</div>
                            {% endif %}
                            {% if form.instance.id %}
                                {% with center_image_url=form.instance|cloudinary_url %}
                                    {% if center_image_url %}
                                        <img src="{{ center_image_url|optimize_cloudinary:'w_300,h_200,c_fill,q_auto' }}" 
                                             alt="ì„¼í„° ì´ë¯¸ì§€" 
                                             class="image-preview">
                                    {% endif %}
                                {% endwith %}
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
        
        <div class="submit-section">
            <button type="submit" class="submit-button">
                ğŸ’¾ ë³€ê²½ì‚¬í•­ ì €ì¥
            </button>
        </div>
    </form>
</div>

<script>
// í¼ì…‹ ì‚­ì œ ì²´í¬ë°•ìŠ¤ ì²˜ë¦¬
document.addEventListener('DOMContentLoaded', function() {
    const deleteCheckboxes = document.querySelectorAll('input[name$="-DELETE"]');
    
    deleteCheckboxes.forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
            const formsetItem = this.closest('.formset-item');
            if (this.checked) {
                formsetItem.classList.add('to-delete');
            } else {
                formsetItem.classList.remove('to-delete');
            }
        });
    });
    
    // ë™ì  í¼ ê´€ë¦¬
    initDynamicFormsets();
});

function initDynamicFormsets() {
    // ìƒë‹´ì‚¬ í¼ì…‹ ê´€ë¦¬
    const therapistContainer = document.getElementById('therapist-forms-container');
    const addTherapistBtn = document.getElementById('add-therapist');
    const therapistTotalForms = document.getElementById('id_therapists-TOTAL_FORMS');
    
    // ì´ë¯¸ì§€ í¼ì…‹ ê´€ë¦¬
    const imageContainer = document.getElementById('image-forms-container');
    const addImageBtn = document.getElementById('add-image');
    const imageTotalForms = document.getElementById('id_centerimages-TOTAL_FORMS');
    
    // ìƒë‹´ì‚¬ ì¶”ê°€ ë²„íŠ¼ ì´ë²¤íŠ¸
    if (addTherapistBtn && therapistContainer && therapistTotalForms) {
        addTherapistBtn.addEventListener('click', function() {
            addTherapistForm(therapistContainer, therapistTotalForms);
        });
        
        // ê¸°ì¡´ ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë“±ë¡
        bindTherapistRemoveEvents();
    }
    
    // ì´ë¯¸ì§€ ì¶”ê°€ ë²„íŠ¼ ì´ë²¤íŠ¸
    if (addImageBtn && imageContainer && imageTotalForms) {
        addImageBtn.addEventListener('click', function() {
            addImageForm(imageContainer, imageTotalForms);
        });
        
        // ê¸°ì¡´ ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë“±ë¡
        bindImageRemoveEvents();
    }
}

function addTherapistForm(container, totalFormsInput) {
    const currentForms = parseInt(totalFormsInput.value);
    const newFormIndex = currentForms;
    
    // ë¹ˆ í¼ í…œí”Œë¦¿ (ì„œë²„ì—ì„œ ë°›ì€ ë¹ˆ í¼ì„ ê¸°ë°˜ìœ¼ë¡œ)
    const emptyFormHtml = getTherapistFormTemplate(newFormIndex);
    
    // ìƒˆ í¼ ì—˜ë¦¬ë¨¼íŠ¸ ìƒì„±
    const newFormDiv = document.createElement('div');
    newFormDiv.className = 'formset-item fade-in';
    newFormDiv.setAttribute('data-form-index', newFormIndex);
    newFormDiv.innerHTML = emptyFormHtml;
    
    // ì»¨í…Œì´ë„ˆì— ì¶”ê°€
    container.appendChild(newFormDiv);
    
    // ì´ í¼ ê°œìˆ˜ ì—…ë°ì´íŠ¸
    totalFormsInput.value = currentForms + 1;
    
    // ìƒˆ í¼ì˜ ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë“±ë¡
    bindTherapistRemoveEvents();
    
    // ë²ˆí˜¸ ì—…ë°ì´íŠ¸
    updateTherapistNumbers();
}

function addImageForm(container, totalFormsInput) {
    const currentForms = parseInt(totalFormsInput.value);
    const newFormIndex = currentForms;
    
    // ë¹ˆ í¼ í…œí”Œë¦¿
    const emptyFormHtml = getImageFormTemplate(newFormIndex);
    
    // ìƒˆ í¼ ì—˜ë¦¬ë¨¼íŠ¸ ìƒì„±
    const newFormDiv = document.createElement('div');
    newFormDiv.className = 'formset-item fade-in';
    newFormDiv.setAttribute('data-form-index', newFormIndex);
    newFormDiv.innerHTML = emptyFormHtml;
    
    // ì»¨í…Œì´ë„ˆì— ì¶”ê°€
    container.appendChild(newFormDiv);
    
    // ì´ í¼ ê°œìˆ˜ ì—…ë°ì´íŠ¸
    totalFormsInput.value = currentForms + 1;
    
    // ìƒˆ í¼ì˜ ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë“±ë¡
    bindImageRemoveEvents();
    
    // ë²ˆí˜¸ ì—…ë°ì´íŠ¸
    updateImageNumbers();
}

function bindTherapistRemoveEvents() {
    const removeButtons = document.querySelectorAll('.remove-therapist');
    removeButtons.forEach(function(button) {
        // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
        button.replaceWith(button.cloneNode(true));
    });
    
    // ìƒˆë¡œìš´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
    document.querySelectorAll('.remove-therapist').forEach(function(button) {
        button.addEventListener('click', function() {
            const formItem = this.closest('.formset-item');
            removeFormWithAnimation(formItem, function() {
                const totalFormsInput = document.getElementById('id_therapists-TOTAL_FORMS');
                totalFormsInput.value = parseInt(totalFormsInput.value) - 1;
                updateTherapistNumbers();
                reindexTherapistForms();
            });
        });
    });
}

function bindImageRemoveEvents() {
    const removeButtons = document.querySelectorAll('.remove-image');
    removeButtons.forEach(function(button) {
        // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
        button.replaceWith(button.cloneNode(true));
    });
    
    // ìƒˆë¡œìš´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
    document.querySelectorAll('.remove-image').forEach(function(button) {
        button.addEventListener('click', function() {
            const formItem = this.closest('.formset-item');
            removeFormWithAnimation(formItem, function() {
                const totalFormsInput = document.getElementById('id_centerimages-TOTAL_FORMS');
                totalFormsInput.value = parseInt(totalFormsInput.value) - 1;
                updateImageNumbers();
                reindexImageForms();
            });
        });
    });
}

function removeFormWithAnimation(formItem, callback) {
    formItem.classList.add('fade-out');
    setTimeout(function() {
        formItem.remove();
        if (callback) callback();
    }, 300);
}

function updateTherapistNumbers() {
    const therapistForms = document.querySelectorAll('#therapist-forms-container .formset-item');
    therapistForms.forEach(function(form, index) {
        const header = form.querySelector('.formset-item-header h4');
        if (header) {
            header.textContent = `ìƒë‹´ì‚¬ #${index + 1}`;
        }
    });
}

function updateImageNumbers() {
    const imageForms = document.querySelectorAll('#image-forms-container .formset-item');
    imageForms.forEach(function(form, index) {
        const header = form.querySelector('.formset-item-header h4');
        if (header) {
            header.textContent = `ì´ë¯¸ì§€ #${index + 1}`;
        }
    });
}

function reindexTherapistForms() {
    const therapistForms = document.querySelectorAll('#therapist-forms-container .formset-item');
    therapistForms.forEach(function(form, index) {
        // í¼ ì¸ë±ìŠ¤ ì—…ë°ì´íŠ¸
        form.setAttribute('data-form-index', index);
        
        // ëª¨ë“  ì…ë ¥ í•„ë“œì˜ nameê³¼ id ì—…ë°ì´íŠ¸
        const inputs = form.querySelectorAll('input, select, textarea');
        inputs.forEach(function(input) {
            const name = input.getAttribute('name');
            const id = input.getAttribute('id');
            
            if (name && name.includes('therapists-')) {
                const newName = name.replace(/therapists-\d+/, `therapists-${index}`);
                input.setAttribute('name', newName);
            }
            
            if (id && id.includes('therapists-')) {
                const newId = id.replace(/therapists-\d+/, `therapists-${index}`);
                input.setAttribute('id', newId);
            }
        });
        
        // ë¼ë²¨ì˜ for ì†ì„±ë„ ì—…ë°ì´íŠ¸
        const labels = form.querySelectorAll('label');
        labels.forEach(function(label) {
            const forAttr = label.getAttribute('for');
            if (forAttr && forAttr.includes('therapists-')) {
                const newFor = forAttr.replace(/therapists-\d+/, `therapists-${index}`);
                label.setAttribute('for', newFor);
            }
        });
    });
}

function reindexImageForms() {
    const imageForms = document.querySelectorAll('#image-forms-container .formset-item');
    imageForms.forEach(function(form, index) {
        // í¼ ì¸ë±ìŠ¤ ì—…ë°ì´íŠ¸
        form.setAttribute('data-form-index', index);
        
        // ëª¨ë“  ì…ë ¥ í•„ë“œì˜ nameê³¼ id ì—…ë°ì´íŠ¸
        const inputs = form.querySelectorAll('input, select, textarea');
        inputs.forEach(function(input) {
            const name = input.getAttribute('name');
            const id = input.getAttribute('id');
            
            if (name && name.includes('centerimages-')) {
                const newName = name.replace(/centerimages-\d+/, `centerimages-${index}`);
                input.setAttribute('name', newName);
            }
            
            if (id && id.includes('centerimages-')) {
                const newId = id.replace(/centerimages-\d+/, `centerimages-${index}`);
                input.setAttribute('id', newId);
            }
        });
        
        // ë¼ë²¨ì˜ for ì†ì„±ë„ ì—…ë°ì´íŠ¸
        const labels = form.querySelectorAll('label');
        labels.forEach(function(label) {
            const forAttr = label.getAttribute('for');
            if (forAttr && forAttr.includes('centerimages-')) {
                const newFor = forAttr.replace(/centerimages-\d+/, `centerimages-${index}`);
                label.setAttribute('for', newFor);
            }
        });
    });
}

function getTherapistFormTemplate(index) {
    return `
        <div class="formset-item-header">
            <h4>ìƒë‹´ì‚¬ #${index + 1}</h4>
            <div class="formset-item-controls">
                <button type="button" class="btn btn-danger remove-therapist">
                    â– ì‚­ì œ
                </button>
            </div>
        </div>
        
        <input type="hidden" name="therapists-${index}-id" id="id_therapists-${index}-id">
        
        <div class="form-row">
            <div class="form-group">
                <label for="id_therapists-${index}-name">ì´ë¦„:</label>
                <input type="text" name="therapists-${index}-name" id="id_therapists-${index}-name" maxlength="100" required>
            </div>
            
            <div class="form-group">
                <label for="id_therapists-${index}-experience">ê²½ë ¥ (ë…„):</label>
                <input type="number" name="therapists-${index}-experience" id="id_therapists-${index}-experience" min="0">
            </div>
        </div>
        
        <div class="form-group">
            <label for="id_therapists-${index}-specialty">ì „ë¬¸ë¶„ì•¼:</label>
            <input type="text" name="therapists-${index}-specialty" id="id_therapists-${index}-specialty" maxlength="200">
        </div>
        
        <div class="form-group">
            <label for="id_therapists-${index}-description">ì„¤ëª…:</label>
            <textarea name="therapists-${index}-description" id="id_therapists-${index}-description" rows="3" style="width: 100% !important; box-sizing: border-box;"></textarea>
        </div>
        
        <div class="form-group">
            <label for="id_therapists-${index}-photo">ì‚¬ì§„:</label>
            <input type="file" name="therapists-${index}-photo" id="id_therapists-${index}-photo" accept="image/*">
        </div>
    `;
}

function getImageFormTemplate(index) {
    return `
        <div class="formset-item-header">
            <h4>ì´ë¯¸ì§€ #${index + 1}</h4>
            <div class="formset-item-controls">
                <button type="button" class="btn btn-danger remove-image">
                    â– ì‚­ì œ
                </button>
            </div>
        </div>
        
        <input type="hidden" name="centerimages-${index}-id" id="id_centerimages-${index}-id">
        
        <div class="form-group">
            <label for="id_centerimages-${index}-image">ì´ë¯¸ì§€:</label>
            <input type="file" name="centerimages-${index}-image" id="id_centerimages-${index}-image" accept="image/*">
        </div>
    `;
}
</script>
{% endblock %} 